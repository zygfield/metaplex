import './App.css';
import { useEffect, useMemo, useRef } from 'react';

import Home from './Home';

import * as anchor from '@project-serum/anchor';
import { clusterApiUrl } from '@solana/web3.js';
import { WalletAdapterNetwork } from '@solana/wallet-adapter-base';
import {
  getPhantomWallet,
  getSolflareWallet,
  getSolletWallet,
} from '@solana/wallet-adapter-wallets';

import {
  ConnectionProvider,
  WalletProvider,
} from '@solana/wallet-adapter-react';

import { WalletDialogProvider } from '@solana/wallet-adapter-material-ui';
import { ThemeProvider, createTheme } from '@material-ui/core';
import { ConfettiProvider } from './confetti';
import '@fontsource/lato/300.css';
import '@fontsource/lato/400.css';
import '@fontsource/lato/700.css';
import '@fontsource/lato/900.css';


const theme = createTheme({
  typography: {
    fontFamily: 'Lato, Arial',
  },
  palette: {
    type: 'dark',
  },
});

const candyMachineId = process.env.REACT_APP_CANDY_MACHINE_ID
  ? new anchor.web3.PublicKey(process.env.REACT_APP_CANDY_MACHINE_ID)
  : undefined;

const fairLaunchId = new anchor.web3.PublicKey(
  process.env.REACT_APP_FAIR_LAUNCH_ID!,
);

const network = process.env.REACT_APP_SOLANA_NETWORK as WalletAdapterNetwork;

const rpcHost = process.env.REACT_APP_SOLANA_RPC_HOST!;
const connection = new anchor.web3.Connection(rpcHost);

const startDateSeed = parseInt(process.env.REACT_APP_CANDY_START_DATE!, 10);

const txTimeout = 30000; // milliseconds (confirm this works for your project)

const App = () => {
  const endpoint = useMemo(() => clusterApiUrl(network), []);

  const wallets = useMemo(
    () => [getPhantomWallet(), getSolflareWallet(), getSolletWallet()],
    [],
  );

  const canvasRef = useRef<HTMLCanvasElement>(null);
  const imageRef = useRef(new Image())

  useEffect(() => {
    const canvas = canvasRef.current
    let observer: ResizeObserver;

    if(canvas) {
      const context = canvas.getContext('2d');
      if(context) {
        const render = () => {
          const dpr = window.devicePixelRatio || 1;
          const rect = canvas.getBoundingClientRect(); // css
          canvas.width = rect.width * dpr;
          canvas.height = rect.height * dpr;
          context.scale(dpr, dpr);
          context.fillStyle = '#2D1428'
          context.fillRect(0, 0, context.canvas.width, context.canvas.height)

          // const cx = Math.max(context.canvas.width, context.canvas.height) / 2

          // var grad = context.createRadialGradient(cx, cx, 0, cx, cx, 316.23);

          // grad.addColorStop(0.24, 'rgba(45, 20, 40, 1)');
          // grad.addColorStop(0.96, 'rgba(0, 0, 0, 1)');

          // context.fillStyle = grad;
          // context.fillRect(0,0,context.canvas.width, context.canvas.height);

          for (var i = 0; i < 1000; i++) {
            const x = Math.random() * canvas.offsetWidth;
            const y = Math.random() * canvas.offsetHeight;
            const radius = Math.random() * 1.2;
            context.beginPath();
            context.arc(x, y, radius, 0, 360);
            context.fillStyle = "hsla(60,100%,50%,0.3)";
            context.fill();
          }

          const imageHeight = imageRef.current.height;
          const imageWidth = imageRef.current.width;

          if (imageHeight === 0 || imageWidth === 0) {
            return;
          }

          const height = Math.ceil(canvas.height / imageHeight);
          const width = Math.ceil(canvas.width / imageWidth);

          for (let i = 0; i < width; i++) {
            for (let j= 0; j< height; j++) {
              context.save();
              context.translate(i * imageWidth, j * imageHeight);
              if(j % 2 === 1) {
                context.translate(0, imageHeight);
                context.scale(1, -1);
              }
              if(i % 2 === 1) {
                context.translate(imageWidth, 0);
                context.scale(-1, 1);
              }
              context.drawImage(imageRef.current, 0, 0, imageWidth, imageHeight);
              context.restore();
            }
          }
        };

        imageRef.current.onload = render;
        imageRef.current.src = 'bg.png';

        observer = new ResizeObserver(render);

        let root= window.document.getElementById('root');
        if(root) {
          observer.observe(root);
        }
      }
    }

    return () => {
      observer?.disconnect();
    };
  }, []);

  return (
    <ThemeProvider theme={theme}>
      <ConnectionProvider endpoint={endpoint}>
        <WalletProvider wallets={wallets} autoConnect>
          <WalletDialogProvider>
            <ConfettiProvider>
              <canvas ref={canvasRef} style={{ position: 'fixed', top: 0, left: 0, width: '100vw', height: '100vh' }} />
              <div className="header">
                <svg viewBox="0 0 1401 253" fill="none" xmlns="http://www.w3.org/2000/svg">
                  <path d="M484.412 215.353V211.588H480.647V207.824H446.765V211.588H454.294V215.353H450.529V219.118H446.765V211.588H443V249.235H446.765V253H461.824V249.235H465.588V237.941H480.647V234.176H484.412V230.412H488.176V215.353H484.412ZM465.588 219.118H473.118V230.412H465.588V219.118ZM537.099 215.353V211.588H533.335V207.824H499.452V211.588H506.982V215.353H503.217V219.118H499.452V211.588H495.688V249.235H499.452V253H514.511V249.235H518.276V237.941H533.335V234.176H537.099V230.412H540.864V215.353H537.099ZM518.276 219.118H525.805V230.412H518.276V219.118ZM586.022 237.941H570.963V211.588H567.199V207.824H552.14V211.588H559.669V215.353H555.904V219.118H552.14V211.588H548.375V249.235H552.14V253H586.022V249.235H589.787V241.706H586.022V237.941ZM638.724 215.353V211.588H634.96V207.824H601.077V211.588H608.607V215.353H604.842V219.118H601.077V211.588H597.312V249.235H601.077V253H616.136V249.235H619.901V237.941H634.96V234.176H638.724V230.412H642.489V215.353H638.724ZM619.901 219.118H627.43V230.412H619.901V219.118ZM687.647 237.941H672.588V211.588H668.824V207.824H653.765V211.588H661.294V215.353H657.529V219.118H653.765V211.588H650V249.235H653.765V253H687.647V249.235H691.412V241.706H687.647V237.941ZM740.349 207.824H702.702V211.588H710.232V215.353H706.467V219.118H702.702V211.588H698.938V249.235H702.702V253H740.349V249.235H744.114V241.706H740.349V237.941H721.526V234.176H740.349V230.412H744.114V226.647H740.349V222.882H721.526V219.118H740.349V215.353H744.114V211.588H740.349V207.824ZM793.037 211.588H789.272V207.824H759.154V211.588H762.919V215.353H759.154V219.118H755.39V215.353H751.625V249.235H755.39V253H770.449V249.235H774.213V234.176H785.507V249.235H789.272V253H793.037V249.235H796.801V215.353H793.037V211.588ZM785.507 222.882H774.213V219.118H785.507V222.882ZM845.724 207.824H811.842V211.588H815.607V215.353H811.842V219.118H808.077V215.353H804.312V226.647H808.077V230.412H834.43V234.176H808.077V237.941H804.312V249.235H808.077V253H841.96V249.235H845.724V245.471H849.489V226.647H845.724V222.882H826.901V219.118H845.724V215.353H849.489V211.588H845.724V207.824ZM898.412 207.824H860.765V211.588H868.294V215.353H864.529V219.118H860.765V211.588H857V249.235H860.765V253H898.412V249.235H902.176V241.706H898.412V237.941H879.588V234.176H898.412V230.412H902.176V226.647H898.412V222.882H879.588V219.118H898.412V215.353H902.176V211.588H898.412V207.824ZM951.099 211.588H947.335V207.824H913.452V211.588H920.982V215.353H917.217V219.118H913.452V211.588H909.688V249.235H913.452V253H928.511V249.235H932.276V237.941H936.04V241.706H939.805V245.471H943.57V249.235H947.335V253H951.099V249.235H954.864V237.941H951.099V234.176H947.335V230.412H951.099V226.647H954.864V215.353H951.099V211.588ZM932.276 222.882V219.118H943.57V222.882H932.276Z" fill="#E3E4D3"/>
                  <path d="M80.4267 67.4706H14.7796V74.7647H22.0738V82.0588H14.7796V89.3529H7.48552V82.0588H0.191406V140.412H7.48552V147.706H14.7796V155H80.4267V147.706H87.7208V133.118H80.4267V125.824H43.9561V89.3529H80.4267V82.0588H87.7208V74.7647H80.4267V67.4706ZM182.509 74.7647H175.215V67.4706H116.862V74.7647H124.156V82.0588H116.862V89.3529H109.568V82.0588H102.273V140.412H109.568V147.706H116.862V155H175.215V147.706H182.509V140.412H189.803V82.0588H182.509V74.7647ZM167.92 125.824H146.038V89.3529H167.92V125.824ZM277.297 125.824H248.12V74.7647H240.826V67.4706H211.65V74.7647H226.238V82.0588H218.944V89.3529H211.65V74.7647H204.355V147.706H211.65V155H277.297V147.706H284.591V133.118H277.297V125.824ZM372.113 125.824H342.937V74.7647H335.642V67.4706H306.466V74.7647H321.054V82.0588H313.76V89.3529H306.466V74.7647H299.172V147.706H306.466V155H372.113V147.706H379.407V133.118H372.113V125.824ZM474.224 67.4706H401.282V74.7647H415.871V82.0588H408.577V89.3529H401.282V74.7647H393.988V147.706H401.282V155H474.224V147.706H481.518V133.118H474.224V125.824H437.753V118.529H474.224V111.235H481.518V103.941H474.224V96.6471H437.753V89.3529H474.224V82.0588H481.518V74.7647H474.224V67.4706ZM576.306 67.4706H510.659V74.7647H517.953V82.0588H510.659V89.3529H503.364V82.0588H496.07V140.412H503.364V147.706H510.659V155H576.306V147.706H583.6V133.118H576.306V125.824H539.835V89.3529H576.306V82.0588H583.6V74.7647H576.306V67.4706ZM678.388 67.4706H605.446V74.7647H620.035V82.0588H612.741V89.3529H605.446V96.6471H620.035V147.706H627.329V155H656.505V147.706H663.799V96.6471H678.388V89.3529H685.682V74.7647H678.388V67.4706ZM605.446 74.7647H598.152V89.3529H605.446V74.7647ZM780.47 74.7647H773.176V67.4706H714.823V74.7647H722.117V82.0588H714.823V89.3529H707.528V82.0588H700.234V140.412H707.528V147.706H714.823V155H773.176V147.706H780.47V140.412H787.764V82.0588H780.47V74.7647ZM765.881 125.824H743.999V89.3529H765.881V125.824ZM882.552 74.7647H875.258V67.4706H816.905V74.7647H824.199V82.0588H816.905V89.3529H809.611V82.0588H802.316V140.412H809.611V147.706H816.905V155H875.258V147.706H882.552V140.412H889.846V82.0588H882.552V74.7647ZM867.963 125.824H846.081V89.3529H867.963V125.824ZM984.634 74.7647H977.34V67.4706H918.987V74.7647H926.281V82.0588H918.987V89.3529H911.693V82.0588H904.398V140.412H911.693V147.706H918.987V155H977.34V147.706H984.634V140.412H991.928V82.0588H984.634V74.7647ZM970.045 125.824H948.163V89.3529H970.045V125.824ZM1086.72 74.7647H1079.42V67.4706H1021.07V74.7647H1028.36V82.0588H1021.07V89.3529H1013.77V82.0588H1006.48V140.412H1013.77V147.706H1021.07V155H1079.42V147.706H1086.72V140.412H1094.01V82.0588H1086.72V74.7647ZM1072.13 125.824H1050.25V89.3529H1072.13V125.824ZM1188.8 74.7647H1181.5V67.4706H1123.15V74.7647H1130.44V82.0588H1123.15V89.3529H1115.86V82.0588H1108.56V140.412H1115.86V147.706H1123.15V155H1181.5V147.706H1188.8V140.412H1196.09V82.0588H1188.8V74.7647ZM1174.21 125.824H1152.33V89.3529H1174.21V125.824ZM1290.88 74.7647H1283.59V67.4706H1225.23V74.7647H1232.53V82.0588H1225.23V89.3529H1217.94V82.0588H1210.64V140.412H1217.94V147.706H1225.23V155H1283.59V147.706H1290.88V140.412H1298.17V82.0588H1290.88V74.7647ZM1276.29 125.824H1254.41V89.3529H1276.29V125.824ZM1392.96 74.7647H1385.67V67.4706H1320.02V74.7647H1334.61V82.0588H1327.31V89.3529H1320.02V74.7647H1312.73V147.706H1320.02V155H1349.2V147.706H1356.49V125.824H1363.79V133.118H1371.08V140.412H1378.37V147.706H1385.67V155H1392.96V147.706H1400.26V125.824H1392.96V118.529H1385.67V111.235H1392.96V103.941H1400.26V82.0588H1392.96V74.7647ZM1356.49 96.6471V89.3529H1378.37V96.6471H1356.49Z" fill="#E3E4D3"/>
                  <path d="M665.412 0.823528H627.765V4.58823H635.294V8.35294H631.529V12.1176H627.765V15.8824H635.294V42.2353H639.059V46H654.118V42.2353H657.882V15.8824H665.412V12.1176H669.176V4.58823H665.412V0.823528ZM627.765 4.58823H624V12.1176H627.765V4.58823ZM718.099 4.58823V0.823528H710.57V4.58823H706.805V15.8824H699.276V4.58823H695.511V0.823528H680.452V4.58823H687.982V8.35294H684.217V12.1176H680.452V4.58823H676.688V42.2353H680.452V46H695.511V42.2353H699.276V27.1765H706.805V42.2353H710.57V46H718.099V42.2353H721.864V4.58823H718.099ZM770.787 0.823528H733.14V4.58823H740.669V8.35294H736.904V12.1176H733.14V4.58823H729.375V42.2353H733.14V46H770.787V42.2353H774.551V34.7059H770.787V30.9412H751.963V27.1765H770.787V23.4118H774.551V19.6471H770.787V15.8824H751.963V12.1176H770.787V8.35294H774.551V4.58823H770.787V0.823528Z" fill="#E3E4D3"/>
                </svg>
                <span>in collaboration with Cloud Eater Studios</span>
              </div>
              <Home
                candyMachineId={candyMachineId}
                fairLaunchId={fairLaunchId}
                connection={connection}
                startDate={startDateSeed}
                txTimeout={txTimeout}
              />
            </ConfettiProvider>
          </WalletDialogProvider>
        </WalletProvider>
      </ConnectionProvider>
    </ThemeProvider>
  );
};

export default App;
